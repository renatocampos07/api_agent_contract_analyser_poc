<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Reverse Prompting - Refinamento Iterativo de Regras</title>
    <style>
    /* 1. ESTRUTURA GLOBAL (SEM SCROLL NA JANELA) */
    html, body { 
        height: 100%; 
        margin: 0; 
        padding: 0; 
        overflow: hidden; /* Trava a rolagem da janela principal */
        font-family: "Segoe UI", Arial, sans-serif; 
        background: #f0f2f5; 
        color: #0f172a; 
    }

    .container { 
        height: 100vh; 
        display: flex; 
        flex-direction: column; 
        padding: 20px 30px; 
        box-sizing: border-box; 
        max-width: 100%; 
    }

    h2 { font-size: 1.5rem; font-weight: 600; margin: 0 0 20px 0; flex: 0 0 auto; }

    /* 2. LAYOUT DIVIDIDO (FLEXBOX ROBUSTO) */
    .layout { 
        display: flex; 
        gap: 24px; 
        flex: 1; /* Ocupa a altura restante */
        min-height: 0; /* Crucial para o scroll interno funcionar no Firefox/Chrome */
        overflow: hidden; 
    }

    /* 3. PAINEL ESQUERDO (CONFIGURAÃ‡Ã•ES - CLARO) */
    .settings-panel { 
        flex: 0 0 600px; /* Largura fixa */
        max-width: 600px; 
        background: #ffffff; 
        border-radius: 14px; 
        box-shadow: 0 4px 15px rgba(15, 23, 42, 0.08); 
        padding: 24px; 
        display: flex; 
        flex-direction: column; 
        height: 100%; 
        box-sizing: border-box; 
        overflow-y: auto; /* Scroll AQUI */
    }

    /* 4. PAINEL DIREITO (RESULTADOS - ESCURO/TERMINAL) */
    .output-panel { 
        flex: 1; /* Ocupa o resto da largura */
        min-width: 400px;
        background: #1e1e1e; /* Fundo Preto estilo VS Code */
        color: #d4d4d4;      /* Texto claro */
        border-radius: 14px; 
        box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2); 
        padding: 0; /* Sem padding para o header colar nas bordas */
        display: flex; 
        flex-direction: column; 
        height: 100%; 
        box-sizing: border-box; 
        overflow: hidden; 
    }

    /* HEADER DO PAINEL DIREITO */
    .panel-header {
        background: #252526;
        padding: 15px 20px;
        font-weight: 600;
        font-size: 0.95rem;
        border-bottom: 1px solid #333;
        display: flex;
        justify-content: space-between;
        align-items: center;
        flex: 0 0 auto;
    }

    /* ÃREA DE SCROLL DA TABELA */
    .output-scroll-area {
        flex: 1;
        overflow-y: auto;
        padding: 0;
    }

    /* ESTILOS DA TABELA DARK MODE */
    table { border-collapse: collapse; width: 100%; table-layout: fixed; font-size: 12px; }
    
    th { 
        background: #2d2d2d; 
        color: #cccccc; 
        position: sticky; top: 0; z-index: 10; 
        text-align: left; 
        padding: 10px 15px; 
        border-bottom: 1px solid #3e3e42;
        font-weight: 600;
    }
    
    td { 
        border-bottom: 1px solid #333; 
        padding: 12px 15px; 
        vertical-align: top; 
        word-wrap: break-word; 
        color: #d4d4d4; 
    }
    
    tr:hover { background-color: #2a2d2e; }

    /* Estilo para separador de sessÃ£o */
    .session-separator td {
        background: #3f3f46;
        color: #fff;
        font-weight: bold;
        text-align: center;
        padding: 8px;
        font-size: 11px;
        letter-spacing: 1px;
        border-top: 2px solid #52525b;
    }

    /* CAMPOS DO FORMULÃRIO */
    .field { display: flex; flex-direction: column; gap: 6px; margin-bottom: 15px; }
    label { font-weight: 600; font-size: 0.85rem; color: #374151; margin-left: 2px; }
    
    .field input:not([type="checkbox"]), 
    .field textarea { 
        width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #d1d5db; 
        font-size: 13px; font-family: inherit; box-sizing: border-box; 
    }
    .field textarea { resize: vertical; min-height: 60px; } 

    /* CHECKBOX */
    .checkbox-row {
        display: flex; flex-direction: row; align-items: center; gap: 10px;
        background: #f9fafb; padding: 10px; border-radius: 8px; border: 1px solid #e5e7eb;
        margin-bottom: 15px;
    }
    .checkbox-row input { width: auto !important; cursor: pointer; }
    .checkbox-row label { margin: 0; cursor: pointer; font-weight: 500; font-size: 0.9rem; }

    /* COLLAPSIBLE */
    .collapsible-header { 
        cursor: pointer; font-weight: 600; background: #f1f5f9; padding: 10px 12px; 
        border-radius: 8px; color: #334155; display: flex; justify-content: space-between; align-items: center; 
    }
    .collapsible-header:hover { background: #e2e8f0; }

    /* BOTÃ•ES */
    .btn-group { display: flex; gap: 10px; margin-top: 10px; padding-bottom: 10px; }
    .btn { border: none; border-radius: 6px; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: 0.2s; }
    .btn-success { background: #16a34a; color: #fff; }
    .btn-secondary { background: #e5e7eb; color: #374151; }

    /* MOBILE */
    @media (max-width: 1100px) { 
        html, body { overflow: auto; height: auto; } 
        .container { height: auto; padding: 15px; }
        .layout { flex-direction: column; height: auto; } 
        .settings-panel { max-width: 100%; min-height: auto; }
        .output-panel { min-height: 500px; }
    }

    /* NOVO: Estilo para CabeÃ§alhos DinÃ¢micos injetados no TBODY */
    .dynamic-header th {
        background: #2d2d2d; 
        color: #cccccc; 
        text-align: left; 
        padding: 10px 15px; 
        border-bottom: 1px solid #3e3e42;
        font-weight: 600;
        font-size: 11px;
        text-transform: uppercase;
        letter-spacing: 0.5px;
    }

    /* Ajuste: Cor neutra e sem barra de rolagem */
    .log-clean {
        font-family: 'Consolas', 'Courier New', monospace;
        font-size: 11px;
        color: #d4d4d4; /* Cinza claro neutro (antes era azulado) */
        white-space: pre-wrap;
        padding: 15px;
        background: transparent;
        border-bottom: 1px dashed #404040;
        /* Removido max-height e overflow para tirar a rolagem */
    }
    </style>
</head>
<body>
<div class="container">
    <h2>Reverse Prompting - Refinamento Iterativo de Regras</h2>
    
    <div class="layout">
        
        <div class="settings-panel">
            <form id="reverse-form">

                <div class="field">
                    <label for="rules-prompt">Regra (Draft ID + TÃ­tulo):</label>
                    <textarea id="rules-prompt" name="rules_prompt" rows="5"></textarea>
                </div>

                <div class="field">
                    <label for="clausula-teste">ClÃ¡usula (Teste):</label>
                    <textarea id="clausula-teste" name="clausula_teste" rows="5"></textarea>
                </div>

                <div class="field">
                    <label for="exemplos-csv">Exemplos & CorreÃ§Ãµes (Ground Truth):</label>
                    <textarea id="exemplos-csv" name="exemplos" rows="5"></textarea>
                </div>


                
                <div class="field">
                    <div class="collapsible-header" onclick="toggleCollapse('system-prompt-collapse')">
                        <span>Auditor (System Prompt)</span> <span>â–¼</span>
                    </div>
                    <div id="system-prompt-collapse" class="collapsible-content" style="display:none; margin-top:5px;">
                        <textarea id="system-prompt" name="system_prompt" rows="8">{{ system_intro_template }}</textarea>
                    </div>
                </div>
                
                <div class="field">
                    <div class="collapsible-header" onclick="toggleCollapse('meta-prompt-collapse')">
                        <span>Engenheiro (Meta Prompt)</span> <span>â–¼</span>
                    </div>
                    <div id="meta-prompt-collapse" class="collapsible-content" style="display:none; margin-top:5px;">
                        <textarea id="meta-prompt" name="meta_prompt" rows="6">{{ meta_prompt_default }}</textarea>
                    </div>
                </div>

                <div class="field">
                    <div class="collapsible-header" onclick="toggleCollapse('red-team-collapse')">
                        <span>Desafiante (Red Team Prompt)</span> <span>â–¼</span>
                    </div>
                    <div id="red-team-collapse" class="collapsible-content" style="display:none; margin-top:5px;">
                        <textarea id="red-team-prompt" name="red_team_prompt" rows="12" placeholder="Prompt do Advogado do Diabo...">{{ red_team_prompt_default }}</textarea>
                        <p style="font-size:11px; color:#666; margin-top:4px;">
                            *Edite aqui a persona do atacante. Ative a execuÃ§Ã£o no botÃ£o abaixo (Flag Vermelha).
                        </p>
                    </div>
                </div>


                <div class="field" style="margin-top:10px;">
                    <div class="collapsible-header" onclick="toggleCollapse('rag-collapse')">
                        <span>Buscar exemplos de contrato (RAG)</span> <span>â–¼</span>
                    </div>
                        <div id="rag-collapse" class="collapsible-content" style="display:none; margin-top:5px; padding:10px; border-radius:8px; border:1px dashed #cbd5f5; background:#f9fafb;">
                            <div class="field" style="margin-bottom:10px;">
                                <label for="rag-file" style="margin-bottom:4px; display:block;">Base de Contratos (.docx ou Ã­ndice .sqlite3):</label>
                                <input type="file" id="rag-file" accept=".docx,.sqlite3" multiple style="padding:6px; background:#fff;">
                            </div>

                            <div style="display: flex; align-items: center; gap: 12px;">
                                <div style="display: flex; align-items: center; background:#fff; padding:2px 6px; border:1px solid #d1d5db; border-radius:6px;">
                                    <label for="rag-top-k" style="margin:0; white-space: nowrap; font-size:12px; color:#555;">Top-K:</label>
                                    <input type="number" id="rag-top-k" min="1" max="10" value="3" 
                                           style="border:none; width:45px; text-align:center; outline:none; font-weight:bold; padding:0; height:24px; background:transparent;">
                                </div>

                                <button type="button" class="btn btn-secondary" id="btnRagBuscar" style="min-width:120px; padding: 6px 10px; font-size: 13px; white-space: nowrap;">
                                    ğŸ” Buscar e Preencher
                                </button>

                                <div style="display: flex; align-items: center; gap: 6px;">
                                    <input type="checkbox" id="rag-only-comments" style="cursor: pointer;">
                                    <label for="rag-only-comments" style="margin:0; font-size:15px; white-space: nowrap; cursor: pointer;">
                                        SÃ³ ClÃ¡usulas Comentadas
                                    </label>
                                </div>
                            </div>

                            <div id="rag-status" style="margin-top:8px; font-size:11px; color:#6b7280; display:none; text-align: center;"></div>
                        </div>
                </div>

                <div style="display: flex; align-items: center; gap: 16px; margin-bottom: 15px;">
                    <div style="display: flex; align-items: center; background:#fff; padding:2px 8px; border:1px solid #d1d5db; border-radius:6px;">
                        <label for="max-attempts" style="margin:0; white-space: nowrap; font-size:13px; color:#555;">MÃ¡x. Tentativas:</label>
                        <input type="number" id="max-attempts" name="max_attempts" min="1" value="5" style="border:none; width:45px; text-align:center; outline:none; font-weight:bold; padding:0; height:24px; background:transparent; margin-left:6px;">
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" id="force_continue" name="force_continue" style="cursor: pointer;">
                        <label for="force_continue" style="margin:0; font-size:14px; white-space: nowrap; cursor: pointer;">
                            Continue atÃ© MÃ¡x.
                        </label>
                    </div>
                    <div style="display: flex; align-items: center; gap: 6px;">
                        <input type="checkbox" id="use_red_team" name="use_red_team" style="cursor: pointer;">
                        <label for="use_red_team" style="margin:0; font-size:14px; white-space: nowrap; cursor: pointer;">
                            Ativar Red Team
                        </label>
                    </div>
                </div>

                <input type="hidden" name="llm_deployment" value="">
                <input type="hidden" name="llm_temperature" value="">

                <div class="btn-group">
                    <button class="btn btn-success" type="submit">Execute</button>
                    <button class="btn btn-secondary" type="button" id="btnGeraExemplos">Preenche Exemplos</button>
                </div>

            </form>
        </div>

        <div class="output-panel">
            <div class="panel-header">
                TERMINAL DE SAÃDA
                <span id="status-tag" style="font-size:11px; background:#333; padding:2px 8px; border-radius:4px; display:none;">Processando...</span>
            </div>
            
            <div class="output-scroll-area">
                <table id="csv-output">
                    <thead></thead> 
                    <tbody>
                        </tbody>
                </table>
            </div>
        </div>

    </div>
</div>

<script>
    function toggleCollapse(id) {
        var el = document.getElementById(id);
        el.style.display = (el.style.display === "none" || el.style.display === "") ? "block" : "none";
    }

    const reverseForm = document.getElementById('reverse-form');
    const exemplosCsvEl = document.getElementById('exemplos-csv');
    const clausulaTesteEl = document.getElementById('clausula-teste');

    const ragFileInput = document.getElementById('rag-file');
    const ragTopKInput = document.getElementById('rag-top-k');
    const ragExtractionMethodSelect = document.getElementById('rag-extraction-method');
    const btnRagBuscar = document.getElementById('btnRagBuscar');
    const ragStatus = document.getElementById('rag-status');

    const colHeader1 = document.getElementById('col-header-1');
    const colHeader2 = document.getElementById('col-header-2');
    const colHeader3 = document.getElementById('col-header-3');

    if (btnRagBuscar) {
        btnRagBuscar.addEventListener('click', async () => {
            ragStatus.style.display = 'block';
            ragStatus.style.color = '#9ca3af'; // Cor neutra de loading
            ragStatus.textContent = 'ğŸ” Buscando exemplos...';

            const files = ragFileInput?.files;
            if (!files || files.length === 0) {
                ragStatus.style.color = '#ef4444';
                ragStatus.textContent = 'Selecione ao menos um arquivo.';
                return;
            }

            // ValidaÃ§Ãµes de arquivo (Mantendo sua lÃ³gica original simplificada aqui para brevidade)
            // ... (assumindo que a validaÃ§Ã£o de docx/sqlite estÃ¡ ok no seu cÃ³digo) ...

            let topK = parseInt(ragTopKInput?.value || '3', 10);
            const formDataRag = new FormData();
            for (let i = 0; i < files.length; i++) {
                formDataRag.append('files', files[i]);
            }
            formDataRag.append('top_k', String(topK));

            const ragOnlyCommentsCheckbox = document.getElementById('rag-only-comments');
            const extractionMethod = (ragOnlyCommentsCheckbox && ragOnlyCommentsCheckbox.checked)
                ? 'hierarquico_comentarios'
                : 'hierarquico_filtrado';
            formDataRag.append('extraction_method', extractionMethod);

            if (clausulaTesteEl && clausulaTesteEl.value.trim()) {
                formDataRag.append('clausula_teste', clausulaTesteEl.value.trim());
            }

            try {
                const resp = await fetch('/playground/rag-context', {
                    method: 'POST',
                    body: formDataRag
                });

                if (!resp.ok) throw new Error('HTTP ' + resp.status);

                const data = await resp.json();
                
                // CORREÃ‡ÃƒO 1: Definindo contextoLista no escopo correto
                const contextoLista = Array.isArray(data.contexto_rag) ? data.contexto_rag : [];

                if (!contextoLista.length) {
                    ragStatus.style.color = '#f59e0b';
                    ragStatus.textContent = 'Nenhum exemplo encontrado.';
                    return;
                }

                // ATUALIZA A TABELA (COM CABEÃ‡ALHOS DINÃ‚MICOS NO TOPO)
                const tbody = document.querySelector('#csv-output tbody');
                if (tbody && Array.isArray(data.logs)) {
                    
                    const fragment = document.createDocumentFragment();

                    // 1. CabeÃ§alho DinÃ¢mico (RAG)
                    const trHead = document.createElement('tr');
                    trHead.className = 'dynamic-header';
                    trHead.innerHTML = `
                        <th style="width:50px; text-align:center;">#</th>
                        <th style="width:40%;">ClÃ¡usula (Contexto)</th>
                        <th style="width:40%;">ComentÃ¡rios Originais</th>
                        <th style="width:100px; text-align:center;">Similaridade</th>
                        <th></th>
                    `;
                    fragment.appendChild(trHead);

                    // 2. Linhas de Dados
                    data.logs.forEach((item, idx) => {
                        const tr = document.createElement('tr');
                        const jsonObj = item.json || {};
                        const nomeArquivo = jsonObj.nome_arquivo || '';
                        const indexP = jsonObj.index_p ?? '';
                        const tipoSecao = jsonObj.tipo_secao || '';
                        const texto = jsonObj.texto || '';
                        
                        const alteracoes = Array.isArray(jsonObj.alteracoes) ? jsonObj.alteracoes : [];
                        const alteracoesStr = alteracoes.length ? JSON.stringify(alteracoes, null, 2) : '';

                        let simVal = jsonObj.similaridade_percentual;
                        let simColor = '#9ca3af';
                        let simText = '';
                        if (typeof simVal === 'number') {
                            simText = simVal.toFixed(1) + '%';
                            if (simVal >= 90) simColor = '#4ade80';
                            else if (simVal >= 80) simColor = '#facc15';
                            else simColor = '#ef4444';
                        }

                        const colunaRegra = `${nomeArquivo} | p=${indexP}\n${texto}`;

                        tr.innerHTML = `
                            <td style="text-align:center; color:#64748b; font-weight:bold;">${item.numero || idx + 1}</td>
                            <td><pre style="white-space:pre-wrap; font-size:11px; margin:0; color:#d4d4d4;">${colunaRegra}</pre></td>
                            <td><pre style="white-space:pre-wrap; font-size:11px; margin:0; color:#93c5fd;">${alteracoesStr}</pre></td>
                            <td style="text-align:center; vertical-align:top;">
                                <span style="font-weight:bold; color:${simColor}; border:1px solid ${simColor}; padding:2px 6px; border-radius:4px; font-size:10px;">
                                    ${simText}
                                </span>
                            </td>
                            <td></td>
                        `;
                        fragment.appendChild(tr);
                    });

                    // Insere no topo
                    tbody.prepend(fragment);
                }

                // CORREÃ‡ÃƒO 2: Atualizando o textarea com a variÃ¡vel correta
                if (exemplosCsvEl) {
                    const atual = exemplosCsvEl.value.trim();
                    const jsonStrings = contextoLista.map(obj => JSON.stringify(obj, null, 2));
                    const blocoNovo = jsonStrings.join('\n\n');
                    
                    // Adiciona quebra se jÃ¡ tiver texto
                    exemplosCsvEl.value = atual ? (atual + '\n\n' + blocoNovo) : blocoNovo;
                }

                ragStatus.style.color = '#10b981';
                ragStatus.textContent = `âœ… ${contextoLista.length} exemplos adicionados.`;

            } catch (err) {
                console.error(err);
                ragStatus.style.color = '#ef4444';
                ragStatus.textContent = 'Erro: ' + err.message;
            }
        });
    }

    reverseForm.addEventListener('submit', async function(e) {
        e.preventDefault();

        const ruleVal = document.getElementById('rules-prompt').value.trim();
        const clauseVal = document.getElementById('clausula-teste').value.trim();
        if (!ruleVal || !clauseVal) {
            alert("Por favor, preencha a 'Regra Inicial' e a 'ClÃ¡usula Alvo' antes de executar.");
            return;
        }

        const tbody = document.querySelector('#csv-output tbody');
        const statusTag = document.getElementById('status-tag');

        if (colHeader1) colHeader1.textContent = 'Regra Gerada/Usada';
        if (colHeader2) colHeader2.textContent = 'Resposta da IA';
        if (colHeader3) colHeader3.textContent = 'Status';
        
        // NÃƒO LIMPA MAIS O TBODY!
        // tbody.innerHTML = ''; 
        
        statusTag.style.display = 'inline-block';
        statusTag.textContent = "â³ Processando...";
        statusTag.style.color = "#fbbf24"; 

        // Cria linha de loading temporÃ¡ria no TOPO
        const loadingRow = document.createElement('tr');
        loadingRow.id = 'loading-row-temp';
        loadingRow.innerHTML = `<td colspan="5" style="text-align:center; padding:30px; color:#94a3b8;">
            <div style="margin-bottom:5px;">â³ Executando nova rodada...</div>
            <div style="font-size:10px; opacity:0.7;">Isso pode levar alguns minutos.</div>
        </td>`;
        tbody.prepend(loadingRow);

        const forceContinue = document.getElementById('force_continue').checked;
        const useRedTeam = document.getElementById('use_red_team')?.checked;
        const redTeamPrompt = document.getElementById('red-team-prompt')?.value;
        const formData = new FormData(this);
        formData.set('force_continue', forceContinue);
        formData.set('use_red_team', useRedTeam);
        formData.set('red_team_prompt', redTeamPrompt);

        try {
            const response = await fetch('/playground/reverse-prompting/process', {
                method: 'POST',
                body: formData
            });
            
            let data;
            try { data = await response.json(); } 
            catch (err) { throw new Error("Erro de comunicaÃ§Ã£o com o servidor."); }

            // Remove loading
            const tempLoad = document.getElementById('loading-row-temp');
            if(tempLoad) tempLoad.remove();

            if (data.tentativas && data.tentativas.length > 0) {
                statusTag.textContent = "âœ… ConcluÃ­do";
                statusTag.style.color = "#4ade80"; 

                // Cria um fragmento para a nova sessÃ£o
                const fragment = document.createDocumentFragment();

                // 1. CABEÃ‡ALHO DINÃ‚MICO (EXECUÃ‡ÃƒO) - No topo do bloco
                const trHead = document.createElement('tr');
                trHead.className = 'dynamic-header';
                trHead.innerHTML = `
                    <th style="width:50px; text-align:center;">#</th>
                    <th style="width:30%;">Regra Gerada/Usada</th>
                    <th style="width:30%;">Resposta da IA</th>
                    <th style="width:80px; text-align:center;">Status</th>
                    <th style="width:30%; text-align:center">Red Team</th>
                `;
                fragment.appendChild(trHead);

                // 2. LINHAS DE DADOS (TENTATIVAS)
                data.tentativas.forEach(t => {
                    const tr = document.createElement('tr');
                    
                    // ... (LÃ³gica de visualizaÃ§Ã£o existente mantida 100%) ...
                    let ruleDisplay = t.regras_aplicadas_texto || "";
                    if(ruleDisplay.length > 20000) ruleDisplay = ruleDisplay.substring(0, 20000) + "...";

                    let statusBg, statusText, statusLabel;
                    if (t.status === 'âœ… Detectou' || t.status === 'matching') {
                        statusBg = '#064e3b'; statusText = '#6ee7b7'; statusLabel = 'âœ… Detectou';
                    } else {
                        statusBg = '#7f1d1d'; statusText = '#fca5a5'; statusLabel = 'âŒ Falhou';
                    }

                    let redTeamHtml = '<div style="text-align:center; color:#475569;">-</div>';
                    if (t.red_team_data) {
                        const jsonRaw = JSON.stringify(t.red_team_data, null, 2);
                        redTeamHtml = `<pre style="font-family: Consolas, monospace; font-size: 11px; color: #d4d4d4; white-space: pre-wrap; margin: 0; background: rgba(0,0,0,0.2); padding: 8px; border-radius: 6px; border: 1px solid #334155;">${jsonRaw}</pre>`;
                    }
                    
                    tr.innerHTML = `
                        <td style="text-align:center; font-weight:bold; color:#a3a3a3;">${t.tentativa}</td>
                        <td><pre style="white-space:pre-wrap; font-family:Consolas, monospace; font-size:11px; margin:0; color:#ce9178;">${ruleDisplay}</pre></td>
                        <td><pre style="white-space:pre-wrap; font-family:Consolas, monospace; font-size:11px; margin:0; color:#9cdcfe;">${t.resposta_ia}</pre></td>
                        <td style="text-align:center;">
                            <span style="padding:4px 8px; border-radius:4px; font-size:11px; font-weight:bold; background:${statusBg}; color:${statusText}; min-width:80px; display:inline-block;">${statusLabel}</span>
                        </td>
                        <td style="vertical-align:top;">${redTeamHtml}</td>
                    `;
                    fragment.appendChild(tr);
                });

                // 3. LINHA DE LOGS (Agora vem ABAIXO das tentativas)
                if (data.logs) {
                    const trLog = document.createElement('tr');
                    trLog.innerHTML = `
                        <td colspan="5" style="padding:0;">
                            <div class="log-clean"><strong>ğŸ“¡ LOG DE EXECUÃ‡ÃƒO:</strong><br>${data.logs}</div>
                        </td>
                    `;
                    fragment.appendChild(trLog);
                }

                // Insere o bloco completo (Header -> Tentativas -> Log) no TOPO da tabela
                tbody.prepend(fragment);

            } else {
                statusTag.textContent = "âš ï¸ Vazio";
                // Mostra erro no topo
                const trErr = document.createElement('tr');
                trErr.innerHTML = `<td colspan="5" style="color:#f87171; padding:20px; text-align:center;">${data.erro || "Nenhuma tentativa retornada."}</td>`;
                tbody.prepend(trErr);
            }
        } catch (err) {
            // Remove loading se der erro
            const tempLoad = document.getElementById('loading-row-temp');
            if(tempLoad) tempLoad.remove();

            statusTag.textContent = "âŒ Erro";
            statusTag.style.color = "#f87171";
            const trFatal = document.createElement('tr');
            trFatal.innerHTML = `<td colspan='5' style='color:#f87171; padding:20px; text-align:center;'>Erro fatal: ${err.message}</td>`;
            tbody.prepend(trFatal);
        }
    });

    // ... (CÃ³digo do btnGeraExemplos mantido igual) ...
    document.getElementById('btnGeraExemplos').onclick = function() {
        {% raw %}
        const sysEl = document.getElementById('system-prompt');
        if (!sysEl.value.trim()) {
            sysEl.value = `[PROMPT]

PERSONA:
VocÃª Ã© um Agente Especialista em Compliance JurÃ­dico e RedaÃ§Ã£o Contratual (Contract Redlining).
Sua arquitetura mental combina o rigor das PolÃ­ticas Sonepar (Nortel, Dimensional, Eletronor - Lei Sapin II).

Sua funÃ§Ã£o Ã©:
1. **Auditor (Array \`comments\`):** Identificar infraÃ§Ãµes Ã s regras de negÃ³cio.

CONTEXTO DE PROCESSAMENTO:
O sistema de backend lerÃ¡ sua resposta. Falhas de formataÃ§Ã£o JSON quebram o sistema.
1. VocÃª deve identificar **TODAS** as ocorrÃªncias de uma infraÃ§Ã£o.
2. NÃ£o pare na primeira infraÃ§Ã£o encontrada. Varra o texto atÃ© o final para cada regra e variaÃ§Ã£o.

OBJETIVO FINAL:
Ler o contrato, aplicar a Base de Regras e gerar um JSON onde cada apontamento de risco (\`comments\`).

==================================================
ESTRUTURA DO JSON (SAÃDA OBRIGATÃ“RIA)
==================================================
A resposta deve ser EXATAMENTE este objeto JSON.
IMPORTANTE: NÃ£o use blocos de cÃ³digo markdown (json). Apenas o texto cru do JSON.
IMPORTANTE: Strings longas no JSON devem usar \n para quebra de linha, nunca quebras reais.

{
output: "String Ãºnica contendo o RELATÃ“RIO HUMANIZADO formatado com caracteres de quebra de linha (\\n). Deve resumir o status de cada regra de Compliance apenas.",
comments: [
{
search: "String EXATA e CURTA encontrada no texto original (Ã¢ncora visual)",
comment: "String contendo: [ID ÃšNICO] | [REGRA XX] - DescriÃ§Ã£o + AÃ§Ã£o Corretiva",
author: "Agent AI",
op_id: "ID Ãºnico (ex: R01-01, R01-02, R28-01...)"
}
],
changes: [
]
}

==================================================
DIRETRIZES DE PREENCHIMENTO E LÃ“GICA
==================================================

### 1. SeparaÃ§Ã£o de FunÃ§Ãµes (CRÃTICO)
* **Array \`comments\` (Compliance):** Use EXCLUSIVAMENTE para apontar violaÃ§Ãµes das REGRAS 001 a 028 listadas abaixo (riscos jurÃ­dicos, clÃ¡usulas ausentes, multas abusivas).

### 2. LÃ³gica de Multiplicidade (Compliance)
Muitas regras possuem variaÃ§Ãµes (LÃ³gica A, LÃ³gica B) e podem ocorrer mÃºltiplas vezes no texto.
* **Regra:** Para cada regra da base (e suas sub-lÃ³gicas), escaneie o documento inteiro independentemente.
* **AÃ§Ã£o:** Se a regra for violada N vezes (somando todas as variaÃ§Ãµes), gere N objetos no array 'comments' e mencione as N ocorrÃªncias no campo 'output'.

### 2.1. LÃ³gica CRÃTICA da Multiplicidade (REGRA 028)
**Para a REGRA 028 (Campos em Branco) e SOMENTE para ela, a identificaÃ§Ã£o de cada um dos 'PadrÃµes de Busca (Visual)' deve ser tratada como um evento de infraÃ§Ã£o **INDIVIDUAL e DISCRETO**, mesmo que mÃºltiplos padrÃµes apareÃ§am na mesma linha ou trecho. A cada '...' ou '___' ou '[ ]' detectado, um novo objeto (e um novo \`op_id\` sequencial) deve ser criado no array \`comments\`. **NUNCA CONSOLIDE** ocorrÃªncias da Regra 028.**

### 3. Campo 'output' (RelatÃ³rio Consolidado)
Gere um relatÃ³rio legÃ­vel dentro de uma Ãºnica string JSON. Use \`\n\` para formatar.
Foque apenas nas Regras de Compliance. NÃ£o liste correÃ§Ãµes gramaticais aqui.
Para cada regra da base, siga este template visual:
---
**REGRA [NÃšMERO]:** [DescriÃ§Ã£o da Regra]
* **OCORRÃŠNCIA:** [Sequencia: 001, 002...]
* **Gatilho Identificado:** [Sim/NÃ£o/NÃ£o AplicÃ¡vel]
* **ClÃ¡usula(s):** [Citar trecho ou "N/A"]
* **Status:** [CONFORME / NÃƒO CONFORME / NÃƒO APLICÃVEL]
* **ComentÃ¡rio/AÃ§Ã£o:** [Copiar a 'AÃ§Ã£o Corretiva' exata se NÃƒO CONFORME]
---

### 4. Campo 'comments'
Gere um item neste array para cada regra de Compliance com status **NÃƒO CONFORME**.
* **Formato do texto 'comment':** "[op_id do comentÃ¡rio] | [REGRA NÃšMERO]:** [DescriÃ§Ã£o da Regra]\n\n**ComentÃ¡rio/AÃ§Ã£o:** [Copiar a 'AÃ§Ã£o Corretiva' da regra]"
* **op_id:** Use um formato lÃ³gico: \`R[NumRegra]-[Sequencial]\`. Ex: \`R28-01\`.

### 5. SeguranÃ§a do JSON (Escaping)
* Se o texto original contiver aspas duplas (\`"\`), vocÃª deve escapÃ¡-las (\`\"\`) dentro das strings do JSON.
* Nunca insira quebras de linha reais dentro dos valores das chaves json. Use sempre \`\n\`.

### REGRAS CRÃTICAS DO CAMPO 'SEARCH' (Risco de Falha no Backend)
O sistema usa busca exata (indexOf). Siga estritamente:
1. **PROIBIDO:** Quebras de linha (\n), Tabs (\t), caracteres de tabela (|, +, --), bullets (*, -).
2. **PROIBIDO:** Frases longas que cruzam linhas no PDF visual.
3. **ESTRATÃ‰GIA:** Se o erro estiver em tabela, lista ou texto quebrado, **busque o TÃ­tulo da ClÃ¡usula** ou uma **expressÃ£o curta e Ãºnica** (mÃ¡x 6 palavras) prÃ³xima ao erro.
4. **EXATIDÃƒO:** Copie o texto exato do input, respeitando maiÃºsculas/minÃºsculas e pontuaÃ§Ã£o.

### INSTRUÃ‡Ã•ES FINAIS (CRÃTICO):
Ao receber o contrato:
1. Leia o contrato completo antes de iniciar a anÃ¡lise
2. Aplique cada regra sequencialmente (001 a 028)
3. Para cada regra, varra o documento inteiro
4. Para regras com mÃºltiplas lÃ³gicas (A, B, C, D), processe cada uma independentemente
5. Gere o JSON seguindo rigorosamente a estrutura especificada

==================================================
[INÃCIO DO CONTRATO]
==================================================
{{{ $tools.document_text_extract_tool.result }}}
==================================================
[FIM DO CONTRATO]
==================================================
`;
        }
        {% endraw %}

        const rulesEl = document.getElementById('rules-prompt');
        if (!rulesEl.value.trim()) {
            rulesEl.value = `**R045 [CondiÃ§Ã£o de Pagamento]**\nAviso prÃ©vio nÃ£o superior a 30 dias de forma imotivada. Exceto para locaÃ§Ãµes em que recomendamos que o prazo seja de no mÃ­nimo 180 dias para realocaÃ§Ã£o da operaÃ§Ã£o Reportar como categoria de probabilidade/impacto: Remota/MÃ©dio/NÃƒO ACEITÃVEL  deverÃ¡ a Ã¡rea requisitante solucionar, e para os contratos de locaÃ§Ã£o deverÃ¡ a gerÃªncia logÃ­stica validar (Novos CDS e unidades com estoque com GerÃªncia de facilities)`;
        }

        const clausulaEl = document.getElementById('clausula-teste');
        if (!clausulaEl.value.trim()) {
            clausulaEl.value = `As Partes concordam que o presente Contrato poderÃ¡ ser rescindido por iniciativa da CONTRATANTE, sem qualquer Ã´nus, mediante notificaÃ§Ã£o escrita com 30 (trinta) dias de antecedÃªncia.`;
        }

        const exemplosEl = document.getElementById('exemplos-csv');
        if (!exemplosEl.value.trim()) {
            exemplosEl.value = `EXEMPLO 1: "Pagamento em 30 dias." -> CORREÃ‡ÃƒO: Erro. MÃ­nimo 60 dias.\nEXEMPLO 2: "Pagamento Ã  vista." -> CORREÃ‡ÃƒO: Erro. Fluxo exige 60 dias.\nEXEMPLO 3: "Pagamento em 60 dias." -> CORREÃ‡ÃƒO: Aprovado.`;
        }

        {% raw %}
        const metaEl = document.getElementById('meta-prompt');
        if (!metaEl.value.trim()) {
            metaEl.value = `################################################################################
### META PROMPT â€“ RegraBuilder-AI
################################################################################

VocÃª Ã© o **RegraBuilder-AI**, um engenheiro especialista em criar e aperfeiÃ§oar regras contratuais iterativamente.
Seu objetivo Ã© produzir uma nova versÃ£o da regra fornecida, ajustando-a conforme a fase evolutiva da tentativa atual ({{tentativa_atual}} de {{max_tentativas}}).

A regra pode ser nova ou uma versÃ£o anterior.
VocÃª deve sempre buscar o ponto Ã³timo entre:
- Risco de falso negativo (muito genÃ©rica)
- Risco de falso positivo (muito especÃ­fica)
- Custo de tokens
- Estabilidade semÃ¢ntica

================================================================================
### 1. COMPORTAMENTO EVOLUTIVO POR TENTATIVA
================================================================================

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”¹ **Tentativas Iniciais** (1 â†’ ~30% do total)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Estilo: **CONCEITUAL, CURTO, GENÃ‰RICO**
Objetivo: Radar aberto para capturar o conceito do erro.

â€¢ Texto mÃ­nimo e abstrato.
â€¢ **Preserve nÃºmeros-chave (Golden Values)** se essenciais (ex: "60 dias"), mas ignore variaÃ§Ãµes linguÃ­sticas.
â€¢ Sem listas de exemplos literais.
â€¢ Estrutura simples (LÃ³gica Ãºnica ou A/B).

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”¹ **Tentativas IntermediÃ¡rias** (~30% â†’ ~70%)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Estilo: **EQUILIBRADO (HÃBRIDO)**
Objetivo: O ponto Ã³timo de produÃ§Ã£o.

â€¢ Adicione sinÃ´nimos comuns e gatilhos semÃ¢nticos.
â€¢ Diferencie papÃ©is claramente (Contratante vs Contratada).
â€¢ Usa princÃ­pios recorrentes encontrados nos exemplos humanos (Ground Truth).
â€¢ Sem copiar trechos literais de nenhuma clÃ¡usula.

â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
ğŸ”¹ **Tentativas Finais** (~70% â†’ 100%)
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
Estilo: **LITERAL, DETALHADO, OVERFITTING**
Objetivo: ForÃ§a bruta para eliminar o erro.

â€¢ Lista ampla de padrÃµes de busca.
â€¢ Pode trazer frases literais ("SE contiver exatamente...") observadas nos Ground Truths.
â€¢ Use blocos C e D para isolar esses casos literais.
â€¢ Maior risco de falso positivo Ã© aceitÃ¡vel.

================================================================================
### 2. COMO UTILIZAR OS DADOS
================================================================================

VocÃª receberÃ¡ os dados brutos no final deste prompt. Use-os assim:

1.  **HistÃ³rico ({{tabela_historico}}):** Se houver falsos negativos, aumente a precisÃ£o. Se houver falsos positivos, reduza a literalidade.
2.  **Ground Truth ({{exemplo_comentario}}):**
    * Identifique padrÃµes recorrentes (ex: "prazo curto", "falta de aviso").
    * Traduza esses padrÃµes para LÃ³gicas de Erro.
    * **AtenÃ§Ã£o:** Nas tentativas finais, use termos literais (ex: â€œ5 diasâ€) encontrados aqui.
3.  **ClÃ¡usula Teste ({{exemplo_texto_original}}):** Use apenas para simular mentalmente se a regra funcionaria. NÃ£o copie o texto dela.

ğŸš« TRAVA DE SEGURANÃ‡A DE TÃ“PICO: VocÃª estÃ¡ ESTRITAMENTE PROIBIDO de alterar o tema central da regra. Se a regra Ã© sobre "Prazo de Pagamento", vocÃª NÃƒO PODE transformÃ¡-la em uma regra sobre "RetenÃ§Ã£o", "Juros" ou "Multa". Mantenha o foco obsessivo na ClÃ¡usula Alvo ({{exemplo_texto_original}}). Se a clÃ¡usula fala de "dias", sua regra TEM QUE falar de "dias". NÃ£o invente critÃ©rios que nÃ£o existem no texto alvo.

================================================================================
### 3. FORMATO OBRIGATÃ“RIO DA REGRA NA SAÃDA
================================================================================

Sua Ãºnica saÃ­da deve ser a NOVA regra, construÃ­da dinamicamente neste formato Markdown plano.
**Regra de Ouro:** Gere APENAS os blocos necessÃ¡rios. Se um bloco (B, C ou D) nÃ£o for necessÃ¡rio, **NÃƒO O ESCREVA**. NÃ£o use "NÃ£o aplicÃ¡vel".

### REGRA [ID] â€“ [TÃ­tulo da Regra]

* **PadrÃµes de Busca:** (Termos chave que evoluem de genÃ©ricos para literais conforme a fase.)

* **LÃ³gica de Erro (A - [Defina o Contexto Principal]):**
    (Descreva a condiÃ§Ã£o SE... ENTÃƒO... para o cenÃ¡rio principal.)
    * **AÃ§Ã£o Corretiva (A):** (A instruÃ§Ã£o clara que deve aparecer no relatÃ³rio.)

* **LÃ³gica de Erro (B - [Defina o Contexto SecundÃ¡rio]):**
    (INSIRA ESTE BLOCO APENAS SE HOUVER DIFERENÃ‡A REAL DE PAPEL OU CENÃRIO)
    * **AÃ§Ã£o Corretiva (B):** (...)

* **LÃ³gica de Erro (C - [Defina o Contexto]):**
    (INSIRA ESTE BLOCO APENAS SE HOUVER UMA SUB-REGRA COMPLEXA)
    * **AÃ§Ã£o Corretiva (C):** (...)

* **LÃ³gica de Erro (D - Casos Literais):**
    (INSIRA ESTE BLOCO APENAS NA FASE FINAL PARA CAPTURAR FRASES EXATAS)
    * **AÃ§Ã£o Corretiva (D):** (...)

* **InstruÃ§Ã£o de Multiplicidade:** Avalie as LÃ³gicas presentes separadamente em todo o texto. Gere UM item no array \`comments\` para CADA ocorrÃªncia de CADA variaÃ§Ã£o encontrada.

================================================================================
### 4. DADOS BRUTOS (CONTEXTO)
================================================================================

### Regra Atual (Draft):
{{json_rule}}

### HistÃ³rico de Tentativas:
{{tabela_historico}}

### ClÃ¡usula Alvo (Teste):
{{exemplo_texto_original}}

### Ground Truth (Exemplos Reais):
{{exemplo_comentario}}

################################################################################
### SUA SAÃDA: GERAR APENAS A NOVA VERSÃƒO DA REGRA NO FORMATO OBRIGATÃ“RIO
################################################################################
`;
        }
        {% endraw %}

        // --- BLOCO NOVO: Preencher Red Team Prompt se vazio ---
        {% raw %}
        const redTeamEl = document.getElementById('red-team-prompt');
        if (redTeamEl && !redTeamEl.value.trim()) {
            redTeamEl.value = `VocÃª Ã© o **Advogado do Diabo**, especialista em "Red Teaming" de contratos corporativos.
    Sua funÃ§Ã£o Ã© testar a robustez da Regra de Compliance, MAS mantendo os pÃ©s no chÃ£o da realidade jurÃ­dica.

    ENTRADAS:
    1. REGRA ATUAL: A lÃ³gica que estÃ¡ sendo testada.
    2. CLÃUSULA ALVO (USUÃRIO): O texto original.
    3. STATUS DA DETECÃ‡ÃƒO: Se a regra pegou ou nÃ£o o erro.
    4. GROUND TRUTH: A polÃ­tica real da empresa.

    ---
    ### SUA MISSÃƒO
    Tente encontrar uma brecha na Regra Atual criando uma **ClÃ¡usula Armadilha**.

    **CENÃRIO A (Ataque de EvasÃ£o):** Se a regra jÃ¡ detectou o erro do usuÃ¡rio, tente criar uma variaÃ§Ã£o do texto que mantenha o risco jurÃ­dico mas **escape** da lÃ³gica da regra (ex: usando sinÃ´nimos complexos, mudando a estrutura frasal, escrevendo nÃºmeros por extenso).
    **CENÃRIO B (Ataque de Ã“bvio):** Se a regra NÃƒO detectou, crie um caso ainda mais gritante para provar a falha.
    **CENÃRIO C (RENDIÃ‡ÃƒO/APROVAÃ‡ÃƒO):**
        Se vocÃª analisar a regra e concluir que ela Ã© **ROBUSTA**, cobrindo bem os sinÃ´nimos e variaÃ§Ãµes lÃ³gicas sem ser rÃ­gida demais, **NÃƒO INVENTE UM ATAQUE FORÃ‡ADO**.
    Admitir que o Engenheiro fez um bom trabalho Ã© parte da sua funÃ§Ã£o.

    ---
    ### ğŸš« RESTRIÃ‡Ã•ES DE REALISMO (Anti-AlucinaÃ§Ã£o)
    1. **Plausibilidade:** A clÃ¡usula armadilha deve parecer escrita por um advogado real ou um fornecedor tentando levar vantagem. NÃ£o crie textos poÃ©ticos ou informais.
    2. **Contexto JurÃ­dico:** NÃ£o invente Leis, Artigos ou Decretos que nÃ£o existem. Use referÃªncias genÃ©ricas ("legislaÃ§Ã£o aplicÃ¡vel", "CÃ³digo Civil") se necessÃ¡rio.
    3. **Foco no Risco:** Ataque a lÃ³gica do risco (prazos, valores, responsabilidades).
    4. **Evite "Edge Cases" MatemÃ¡ticos:** NÃ£o use nÃºmeros absurdos apenas para testar o limite da regra (ex: se o mÃ­nimo Ã© 30 dias, **NÃƒO** use "29 dias"). Use prazos ruins comuns de mercado (ex: "5 dias", "imediato", "15 dias", "48 horas").
    ---
    ### SAÃDA OBRIGATÃ“RIA (JSON PURO)
    {
      "raciocinio": "ExplicaÃ§Ã£o tÃ©cnica da brecha encontrada (ou um elogio breve se a regra for aprovada).",
      "clausula_armadilha": "O texto da armadilha (ou escreva 'NENHUMA' se a regra for robusta)."
    }`;
        }
        {% endraw %}
    };
</script>
</body>
</html>