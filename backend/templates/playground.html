﻿<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Playground de Análise</title>
    <style>
    body { font-family: "Segoe UI", Arial, sans-serif; background: #f0f2f5; margin: 0; padding: 0; color: #0f172a; }
    .page { min-height: 100vh; padding: 40px 24px; box-sizing: border-box; }
    .container { max-width: 1580px; margin: 0 auto; }
    h1 { font-size: 1.75rem; font-weight: 600; margin-bottom: 28px; }

    .layout { display: flex; gap: 32px; align-items: flex-start; min-height: calc(100vh - 112px); }
    .panel { background: #ffffff; border-radius: 14px; box-shadow: 0 16px 40px rgba(15, 23, 42, 0.12); padding: 28px; flex: 1; display: flex; flex-direction: column; min-height: 0; }
    .settings-panel { flex: 0 0 500px; max-width: 520px; position: sticky; top: 32px; align-self: flex-start; max-height: calc(100vh - 112px); overflow-y: auto; scrollbar-gutter: stable; }
    .settings-panel form { display: flex; flex-direction: column; gap: 18px; }
    .output-panel { flex: 1; display: flex; flex-direction: column; gap: 18px; max-height: calc(100vh - 112px); overflow: hidden; align-self: flex-start; }

        label { font-weight: 500; color: #1f2937; }
        .field-row { display: flex; flex-wrap: wrap; gap: 16px; }
    .field { flex: 1; min-width: 240px; display: flex; flex-direction: column; gap: 8px; }
        .checkbox-field { margin-top: 8px; }
        .field input[type="text"], .field input[type="file"] { width: 100%; box-sizing: border-box; padding: 8px 10px; border-radius: 6px; border: 1px solid #d1d5db; font-size: 14px; background: #fff; }
        .field input[type="file"] { padding: 6px; }

    table { border-collapse: collapse; width: 100%; table-layout: fixed; border-radius: 10px; overflow: hidden; }
    th, td { border: 1px solid #e5e7eb; padding: 8px 10px; font-size: 11.2px; }
        th.id-col, td.id-col { width: 26%; max-width: 26%; }
        th.nome-col, td.nome-col { width: 22%; max-width: 22%; }
        th.desc-col, td.desc-col { width: 62%; }
        th.action-col, td.action-col { width: 8%; max-width: 8%; }
        th { background: #f9fafb; font-weight: 600; text-align: left; }
        tr.inactive-row input { color: #6b7280; background: #f3f4f6; }
    input[type="text"] { width: 100%; border: none; background: transparent; font-size: 14px; padding: 2px 4px; }
    .settings-panel table input[type="text"] { font-size: 11.2px; }
        input[disabled] { color: #6b7280; background: #f3f4f6; }

    .buttons { display: flex; gap: 12px; flex-wrap: wrap; }
        .add-btn, .submit-btn { border: none; border-radius: 6px; padding: 10px 20px; font-size: 14px; font-weight: 600; cursor: pointer; transition: transform 0.1s ease, box-shadow 0.2s ease; }
        .add-btn { background: #2563eb; color: #fff; align-self: flex-start; }
        .add-btn:active { transform: scale(0.97); }
        .submit-btn { background: #16a34a; color: #fff; align-self: flex-start; }
        .submit-btn:active { transform: scale(0.97); }
        .del-btn { background: none; border: none; color: #dc2626; font-size: 18px; cursor: pointer; }
        .del-btn:active { transform: scale(0.9); }
        .actions { text-align: center; }

    .status-area { display: flex; flex-direction: column; gap: 8px; flex: 0 0 auto; }
        .loading { font-weight: 600; color: #2563eb; display: none; }
        .download-link { display: none; background: #2563eb; color: #fff; padding: 8px 16px; border-radius: 6px; text-decoration: none; width: fit-content; }
        .download-link:active { transform: scale(0.97); }
        .error { color: #dc2626; margin-bottom: 4px; display: none; }

        .result { flex: 1; display: none; min-height: 0; }
        .result pre { background: #0f172a; color: #f9fafb; padding: 18px; border-radius: 12px; font-size: 14px; line-height: 1.45; font-family: Consolas, "Courier New", monospace; white-space: pre; overflow: auto; height: 100%; box-sizing: border-box; }

        @media (max-width: 1100px) {
            .page { padding: 24px 16px; }
            .layout { flex-direction: column; min-height: auto; gap: 20px; }
            .panel { padding: 24px; }
            .settings-panel { flex: 1; max-width: none; position: static; max-height: none; overflow: visible; }
            .output-panel { max-height: none; }
        }
    </style>
</head>
<body>
    <div class="page">
        <div class="container">
            <h1>Playground de Análise</h1>
            <div class="layout">
                <aside class="panel settings-panel">
                    <form id="analysis-form">
                        <div class="field-row">
                            <div class="field">
                                <label for="file-upload">Arquivo .docx:</label>
                                <input class="file-input" type="file" id="file-upload" accept=".docx" required>
                            </div>
                            <div class="field">
                                <label for="clausulas-alvo">Itens a Analisar (Opcional):</label>
                                <input type="text" id="clausulas-alvo" placeholder="Vazio = Parser-Only | * = Todos | 0;2;5 = Específicos">
                            </div>
                        </div>
                        <div class="field checkbox-field">
                            <label class="toggle-label">
                                <input type="checkbox" id="somente-analisados">
                                Mostrar apenas cláusulas com erros encontrados pela LLM
                            </label>
                        </div>
                        <div class="field checkbox-field">
                            <label class="toggle-label" title="Se marcado, envia o texto completo do documento para uma única análise, ignorando a segmentação em cláusulas. Útil para contratos muito curtos ou testes rápidos.">
                                <input type="checkbox" id="pular-segmentador">
                                Analisar documento inteiro (pular segmentação)
                            </label>
                        </div>

                        <div class="field">
                            <label for="llm-deployment">Deployment LLM (opcional):</label>
                            <select id="llm-deployment" style="width:100%; padding:8px 10px; border-radius:6px; border:1px solid #d1d5db; font-size:14px; background:#fff;">
                                <option value="">(usar padrão do .env)</option>
                                <option value="gpt-4.1-mini">gpt-4.1-mini</option>
                                <option value="gpt-5-mini">gpt-5-mini</option>
                            </select>
                            <small style="color:#6b7280;">Troca apenas o deployment; gpt-5-mini roda sem temperature.</small>
                        </div>
                        <div class="field" style="max-width:160px;">
                            <label for="llm-temperature" title="Temperatura (0-1). Vazio = padrão (0). Ignorada para gpt-5-mini.">Temperature (0-1):</label>
                            <input type="text" id="llm-temperature" placeholder="ex.: 0.2" pattern="^(0(\.\d+)?|1(\.0+)?)$" />
                            <small style="color:#6b7280;">Vazio = 0 (determinístico)</small>
                        </div>

                        <details>
                            <summary style="cursor:pointer; font-weight:600; margin-bottom:10px;">System prompt (intro) personalizado — opcional (expandir)</summary>
                            <div class="field" style="margin: 10px 0 16px 0;">
                                <label for="system-intro">Texto introdutório do system prompt (antes da lista de regras):</label>
                                <textarea id="system-intro" style="width:100%; height: 180px; box-sizing:border-box; font-family: Consolas, 'Courier New', monospace; font-size: 12px; border: 1px solid #d1d5db; border-radius: 8px; padding: 10px;">{{ default_system_intro }}</textarea>
                                <div style="display:flex; gap:8px; margin-top:8px;">
                                    <button type="button" class="add-btn" style="background:#6b7280;" onclick="resetSystemIntro()">Restaurar padrão</button>
                                    <small style="color:#6b7280; align-self:center;">Se deixar vazio, o padrão oficial será usado.</small>
                                </div>
                            </div>
                        </details>

                        <label>Regras Ativas e Personalizadas:</label>
                        <table id="regras-table">
                            <thead>
                                <tr>
                                    <th class="id-col">ID</th>
                                    <th class="nome-col">Regra</th>
                                    <th class="desc-col">Descrição</th>
                                    <th class="action-col actions">Ação</th>
                                </tr>
                            </thead>
                            <tbody id="regras-tbody">
                                {% for rule in standard_rules %}
                                <tr class="inactive-row">
                                    <td class="id-col"><input type="text" value="{{ rule.id_regra }}" disabled></td>
                                    <td class="nome-col"><input type="text" value="{{ rule.nome }}" disabled></td>
                                    <td class="desc-col"><input type="text" value="{{ rule.descricao_prompt }}" disabled></td>
                                    <td class="action-col"></td>
                                </tr>
                                {% endfor %}
                                {% for rule in global_rules %}
                                <tr class="inactive-row">
                                    <td class="id-col"><input type="text" value="{{ rule.id_regra }}" disabled></td>
                                    <td class="nome-col"><input type="text" value="{{ rule.nome }}" disabled></td>
                                    <td class="desc-col"><input type="text" value="{{ rule.descricao_prompt }}" disabled></td>
                                    <td class="action-col"></td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                        <div class="buttons">
                            <button type="button" class="add-btn" onclick="addRegraRow()">Adicionar Regra</button>
                            <button type="submit" class="submit-btn">Analisar Documento</button>
                        </div>
                    </form>
                </aside>
                <section class="panel output-panel">
                    <div class="status-area">
                        <div id="loading" class="loading" style="display:none;">Analisando... (Isso é síncrono e pode levar alguns segundos)</div>
                        <div class="error" id="error-section" style="display:none;"></div>
                    </div>
                    <div style="display:flex; gap:12px; align-items:center;">
                        <a id="download-link" class="download-link" href="#" download>Baixar .docx Revisado</a>
                        <a id="download-csv-link" class="download-link" href="#" download style="background:#16a34a; display:none;">Baixar .csv de Comentários/Alterações</a>
                    </div>
                    <div class="result" id="result-section" style="display:none;">
                        <pre id="json-output"></pre>
                    </div>
                </section>
            </div>
        </div>
    </div>
    <script>
    const form = document.getElementById('analysis-form');
    const fileInput = document.getElementById('file-upload');
    const regrasTbody = document.getElementById('regras-tbody');
    const clausulasInput = document.getElementById('clausulas-alvo');
    const resultSection = document.getElementById('result-section');
    const somenteAnalisadosInput = document.getElementById('somente-analisados');
    const downloadLink = document.getElementById('download-link');
    const jsonOutput = document.getElementById('json-output');
    const errorSection = document.getElementById('error-section');
    const downloadCsvLink = document.getElementById('download-csv-link');
    const loadingEl = document.getElementById('loading');
    const submitBtn = form.querySelector('button[type="submit"]');
    const settingsPanel = document.querySelector('.settings-panel');
    const outputPanel = document.querySelector('.output-panel');
    const systemIntroEl = document.getElementById('system-intro');
    const defaultSystemIntro = systemIntroEl ? systemIntroEl.value : '';

    function syncOutputHeight() {
        if (!settingsPanel || !outputPanel) return;
        const leftHeight = settingsPanel.offsetHeight || 0;
        const baseHeight = Math.max(leftHeight * 0.9, 220);
        const hasResultVisible = resultSection && resultSection.style.display !== 'none';

        outputPanel.style.minHeight = `${baseHeight}px`;
        if (hasResultVisible) {
            outputPanel.style.height = `${Math.max(leftHeight, baseHeight)}px`;
        } else {
            outputPanel.style.height = `${baseHeight}px`;
        }
    }

    window.addEventListener('load', syncOutputHeight);
    window.addEventListener('resize', syncOutputHeight);

    function addRegraRow(id = '', nome = '', desc = '') {
        const tr = document.createElement('tr');
        tr.innerHTML = `
            <td><input class="id-regra" type="text" value="${id}"></td>
            <td><input class="nome-regra" type="text" value="${nome}"></td>
            <td><input class="desc-regra" type="text" value="${desc}"></td>
            <td class="actions"><button type="button" class="del-btn" title="Remover">&times;</button></td>
        `;
        regrasTbody.appendChild(tr);
        syncOutputHeight();
    }

    regrasTbody.addEventListener('click', (event) => {
        const target = event.target;
        if (target.classList.contains('del-btn')) {
            const row = target.closest('tr');
            if (row) {
                row.remove();
                syncOutputHeight();
            }
        }
    });

    function resetSystemIntro() {
        if (systemIntroEl) {
            systemIntroEl.value = defaultSystemIntro;
        }
    }

    document.getElementById('regras-table').addEventListener('paste', function (e) {
        const active = document.activeElement;
        if (!active || !active.closest('#regras-table') || active.disabled) return;
        const clipboard = e.clipboardData || window.clipboardData;

        // Preferir HTML do Excel para preservar quebras de linha internas (Alt+Enter)
        const html = clipboard.getData && clipboard.getData('text/html') || '';
        if (html && html.toLowerCase().includes('<table')) {
            e.preventDefault();
            const parser = new DOMParser();
            const doc = parser.parseFromString(html, 'text/html');
            const table = doc.querySelector('table');
            if (!table) return;

            const matrix = [];
            table.querySelectorAll('tr').forEach(tr => {
                const row = [];
                tr.querySelectorAll('td,th').forEach(td => {
                    // Captura texto visível; trata <br> como espaço para caber em inputs de uma linha
                    let txt = td.textContent || '';
                    txt = txt.replace(/\u00A0/g, ' ');       // &nbsp;
                    txt = txt.replace(/\r?\n/g, ' ');        // quebras internas permanecem na mesma célula
                    txt = txt.replace(/\s+/g, ' ').trim();    // compacta
                    row.push(txt);
                });
                // Ignora linhas totalmente vazias
                if (row.some(c => (c || '').trim() !== '')) {
                    matrix.push(row);
                }
            });

            if (!matrix.length) return;

            const trRef = active.closest('tr');
            const tbody = regrasTbody;
            const rows = Array.from(tbody.querySelectorAll('tr'));
            const inputsRef = Array.from(trRef.querySelectorAll('input'));
            const startColIndex = inputsRef.indexOf(active);

            let startIndex = rows.indexOf(trRef);
            matrix.forEach((cells, i) => {
                const targetIndex = startIndex + i;
                let targetRow = rows[targetIndex];
                // Cria nova linha se necessário ou se a linha alvo não for editável
                if (!targetRow || targetRow.querySelector('input')?.disabled) {
                    addRegraRow();
                    const updated = Array.from(tbody.querySelectorAll('tr'));
                    targetRow = updated[updated.length - 1];
                    rows.push(targetRow);
                }
                const targetInputs = Array.from(targetRow.querySelectorAll('input'));
                // Preenche respeitando a coluna inicial
                cells.forEach((val, j) => {
                    const idx = (startColIndex !== -1) ? (startColIndex + j) : j;
                    if (targetInputs[idx] && !targetInputs[idx].disabled) {
                        targetInputs[idx].value = val;
                    }
                });
            });
            syncOutputHeight();
            return;
        }

        const text = clipboard.getData('text');
        if (!text) return;

        if (text.includes('\t')) {
            e.preventDefault();
            const linhas = text.split(/\r?\n/).filter(l => l.trim());
            if (!linhas.length) {
                return;
            }

            if (linhas.length === 1) {
                const colunas = linhas[0].split('\t');
                const tr = active.closest('tr');
                const inputsInRow = Array.from(tr.querySelectorAll('input'));
                const colIndex = inputsInRow.indexOf(active);
                for (let j = 0; j < colunas.length; j++) {
                    const targetInput = inputsInRow[colIndex + j];
                    if (targetInput && !targetInput.disabled) {
                        targetInput.value = colunas[j].trim();
                    } else if (!targetInput) {
                        addRegraRow();
                        const updatedRows = Array.from(regrasTbody.querySelectorAll('tr'));
                        const newRow = updatedRows[updatedRows.length - 1];
                        const newInputs = Array.from(newRow.querySelectorAll('input'));
                        if (newInputs[colIndex + j] && !newInputs[colIndex + j].disabled) {
                            newInputs[colIndex + j].value = colunas[j].trim();
                        }
                    }
                }
                syncOutputHeight();
                return;
            }

            const trRef = active.closest('tr');
            const inputsRef = Array.from(trRef.querySelectorAll('input'));
            const startColIndex = inputsRef.indexOf(active);
            linhas.forEach((linha, i) => {
                const colunas = linha.split('\t');
                // Se a primeira linha deve preencher a linha atual, não criar nova
                let targetRow;
                if (i === 0) {
                    targetRow = trRef;
                } else {
                    addRegraRow();
                    const updatedRows = Array.from(regrasTbody.querySelectorAll('tr'));
                    targetRow = updatedRows[updatedRows.length - 1];
                }
                const newInputs = Array.from(targetRow.querySelectorAll('input'));
                for (let j = 0; j < colunas.length; j++) {
                    const idx = (startColIndex !== -1) ? (startColIndex + j) : j;
                    if (newInputs[idx] && !newInputs[idx].disabled) {
                        // Colapsa quebras internas para evitar quebrar em múltiplas linhas futuras
                        const val = colunas[j].replace(/\r?\n/g, ' ').replace(/\s+/g, ' ').trim();
                        newInputs[idx].value = val;
                    }
                }
            });
            syncOutputHeight();
            return;
        }

        const lines = text.split(/\r?\n/).filter(l => l.trim());
        if (lines.length <= 1) return;
        e.preventDefault();

        const tr = active.closest('tr');
        const tbody = regrasTbody;
        const rows = Array.from(tbody.querySelectorAll('tr'));
        const inputsInRow = Array.from(tr.querySelectorAll('input'));
        const colIndex = inputsInRow.indexOf(active);
        if (colIndex === -1) return;

        let startIndex = rows.indexOf(tr);
        lines.forEach((line, i) => {
            const targetIndex = startIndex + i;
            let targetRow = rows[targetIndex];
            if (!targetRow) {
                addRegraRow();
                const updatedRows = Array.from(tbody.querySelectorAll('tr'));
                targetRow = updatedRows[updatedRows.length - 1];
                rows.push(targetRow);
            }
            const targetInputs = Array.from(targetRow.querySelectorAll('input'));
            if (targetInputs[colIndex] && !targetInputs[colIndex].disabled) {
                targetInputs[colIndex].value = line.trim();
            }
        });
        syncOutputHeight();
    });

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        if (!fileInput.files[0]) {
            alert('Selecione um arquivo .docx.');
            return;
        }

        submitBtn.disabled = true;
        loadingEl.style.display = 'block';

        resultSection.style.display = 'none';
        downloadLink.style.display = 'none';
        downloadLink.href = '#';
        downloadCsvLink.style.display = 'none';
        downloadCsvLink.href = '#';
        jsonOutput.textContent = '';
        errorSection.style.display = 'none';
        errorSection.textContent = '';

        const regras = [];
        regrasTbody.querySelectorAll('tr').forEach(tr => {
            const inputs = tr.querySelectorAll('input');
            if (inputs.length && !inputs[0].disabled) {
                const id = inputs[0].value.trim();
                const nome = inputs[1].value.trim();
                const desc = inputs[2].value.trim();
                if (id && nome && desc) {
                    const regra = { id_regra: id, nome: nome, descricao_prompt: desc };
                    regras.push(regra);
                }
            }
        });
        const formData = new FormData();
        formData.append('file', fileInput.files[0]);
        formData.append('regras_personalizadas', JSON.stringify(regras));
        formData.append('clausulas_alvo', (clausulasInput.value || '').trim());
        formData.append('somente_analisados', somenteAnalisadosInput.checked ? 'true' : 'false');
    const pularSegmentadorInput = document.getElementById('pular-segmentador');
    formData.append('pular_segmentador', pularSegmentadorInput && pularSegmentadorInput.checked ? 'true' : 'false');
    const llmDeploymentSelect = document.getElementById('llm-deployment');
    if (llmDeploymentSelect) {
        formData.append('llm_deployment_override', (llmDeploymentSelect.value || '').trim());
    }
    const llmTemperatureInput = document.getElementById('llm-temperature');
    if (llmTemperatureInput) {
        formData.append('llm_temperature_override', (llmTemperatureInput.value || '').trim());
    }
        if (systemIntroEl && systemIntroEl.value.trim()) {
            formData.append('system_intro_personalizado', systemIntroEl.value);
        } else {
            formData.append('system_intro_personalizado', '');
        }
        try {
            const response = await fetch('/playground/analisar', {
                method: 'POST',
                body: formData,
            });
            if (!response.ok) {
                const errData = await response.json();
                throw new Error(`Erro ${response.status}: ${errData.detail || 'Erro desconhecido'}`);
            }
            const data = await response.json();
            resultSection.style.display = 'block';
            downloadLink.href = data.download_url;
            downloadLink.style.display = 'inline-block';
            // Prepara botão de download do CSV
            // O nome do arquivo CSV depende do nome do docx validado e da opção de análise
            let csvFilename = '';
            if (data && data.relatorio_json && data.relatorio_json.nome_arquivo) {
                const nomeDocx = data.relatorio_json.nome_arquivo;
                if ((data.apenas_parser || (data.relatorio_json.clausulas && data.relatorio_json.clausulas.length === 0)) && nomeDocx.endsWith('_validado.docx')) {
                    csvFilename = nomeDocx.replace('_validado.docx', '.csv');
                } else if (nomeDocx.endsWith('.docx')) {
                    csvFilename = nomeDocx.replace('.docx', '_validado.csv');
                } else {
                    csvFilename = nomeDocx + '.csv';
                }
            }
            // Mostra botão CSV
            downloadCsvLink.style.display = 'inline-block';
            downloadCsvLink.onclick = async function(e) {
                e.preventDefault();
                downloadCsvLink.textContent = 'Gerando CSV...';
                downloadCsvLink.style.opacity = '0.7';
                try {
                    const formDataCsv = new FormData();
                    // Usa o mesmo arquivo enviado para análise
                    formDataCsv.append('file', fileInput.files[0]);
                    // Decide se é validado ou não pelo nome do arquivo
                    let validado = true;
                    if (clausulasInput.value.trim() === '') validado = false;
                    formDataCsv.append('validado', validado ? 'true' : 'false');
                    const resp = await fetch('/playground/exportar_csv', {
                        method: 'POST',
                        body: formDataCsv
                    });
                    if (!resp.ok) throw new Error('Falha ao gerar CSV');
                    const blob = await resp.blob();
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = csvFilename || 'comentarios_alteracoes.csv';
                    document.body.appendChild(a);
                    a.click();
                    setTimeout(() => {
                        window.URL.revokeObjectURL(url);
                        a.remove();
                    }, 100);
                } catch (err) {
                    alert('Erro ao exportar CSV: ' + err.message);
                } finally {
                    downloadCsvLink.textContent = 'Baixar .csv de Comentários/Alterações';
                    downloadCsvLink.style.opacity = '1';
                }
            };
            // Mostrar a resposta completa; garantir "rules" em uma única linha de forma robusta (sem regex frágil)
            // Estratégia: clonar o objeto, substituir rules por um placeholder e então injetar o JSON compacto.
            let pretty;
            try {
                const cloned = JSON.parse(JSON.stringify(data));
                if (cloned && Array.isArray(cloned.rules)) {
                    const compactRules = JSON.stringify(cloned.rules);
                    cloned.rules = "__INLINE_RULES__";
                    pretty = JSON.stringify(cloned, null, 2).replace("\"__INLINE_RULES__\"", compactRules);
                } else {
                    pretty = JSON.stringify(data, null, 2);
                }
            } catch (e) {
                pretty = JSON.stringify(data, null, 2);
            }
            jsonOutput.textContent = pretty;
            errorSection.style.display = 'none';
            syncOutputHeight();
        } catch (err) {
            errorSection.textContent = err.message;
            errorSection.style.display = 'block';
            resultSection.style.display = 'none';
        } finally {
            loadingEl.style.display = 'none';
            submitBtn.disabled = false;
            syncOutputHeight();
        }
    });

    syncOutputHeight();
    </script>
</body>
</html>